<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Papers in a Hat</title>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/7.12.0/firebase-app.js"></script>
  <!-- include only the Firebase features as you need -->
  <script defer src="/__/firebase/7.12.0/firebase-analytics.js"></script>
  <script defer src="/__/firebase/7.12.0/firebase-auth.js"></script>
  <script defer src="/__/firebase/7.12.0/firebase-database.js"></script>
  <script defer src="/__/firebase/7.12.0/firebase-firestore.js"></script>
  <script defer src="/__/firebase/7.12.0/firebase-messaging.js"></script>
  <script defer src="/__/firebase/7.12.0/firebase-storage.js"></script>
  <!-- initialize the SDK after all desired features are loaded -->
  <script defer src="/__/firebase/init.js"></script>

  <style media="screen">
    body {
      background: #ECEFF1;
      color: rgba(0, 0, 0, 0.87);
      font-family: Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      text-transform: uppercase;
    }

    #message {
      background: white;
      max-width: 360px;
      margin: 100px auto 16px;
      padding: 32px 24px;
      border-radius: 3px;
    }

    #message h2 {
      color: #ffa100;
      font-weight: bold;
      font-size: 16px;
      margin: 0 0 8px;
    }

    #message h1 {
      font-size: 22px;
      font-weight: 300;
      color: rgba(0, 0, 0, 0.6);
      margin: 0 0 16px;
    }

    #message p {
      line-height: 140%;
      margin: 16px 0 24px;
      font-size: 14px;
    }

    #message a {
      display: block;
      text-align: center;
      background: #039be5;
      text-transform: uppercase;
      text-decoration: none;
      color: white;
      padding: 16px;
      border-radius: 4px;
    }

    #message,
    #message a {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
    }

    #load {
      color: rgba(0, 0, 0, 0.4);
      text-align: center;
      font-size: 13px;
    }

    p {
      text-transform: uppercase;
    }

    input {
      display: block;
      text-align: center;
      width: 90%;
      font-size: 16px;
      text-transform: uppercase;
      text-decoration: none;
      padding: 16px;
      border-radius: 4px;
    }

    button {
      display: block;
      text-align: center;
      width: 100%;
      font-size: 16px;
      background: #039be5;
      text-transform: uppercase;
      text-decoration: none;
      color: white;
      padding: 16px;
      border-radius: 4px;
    }

    #room-header {
      font-style: italic;
    }

    #room-id {
      font-weight: bold;
    }

    @media (max-width: 600px) {

      body,
      #message {
        margin-top: 0;
        background: white;
        box-shadow: none;
      }

      body {
        border-top: 16px solid #ffa100;
      }
    }
  </style>
</head>

<body>
  <div id="message">
    <h2>Papers in a Hat</h2>

    <!-- TODO select room from lobby. -->
    <div id="lobby-content" style="display: none;">
      <input id="room-id-input-text" type="text" placeholder="ROOM ID">
      <button id="join-room-button">Join</button>
      <button id="create-room-button">Create a Room</button>
    </div>

    <!-- TODO exit room and go to lobby. -->
    <div id="room-content" style="display: none;">
      <p id="room-header" style="display: inline;">Room ID:
        <div id="room-id" style="display: inline;"></div>
      </p>

      <!-- Insert new paper. -->
      <input id="word-input-text" type="text" placeholder="WRITE SOMETHING HERE">
      <button id="word-input-button">Insert</button>

      <!-- Count of papers. -->
      <p />
      <p id="count-in-hat" style="display: inline;">&nbsp;<br />
        <div id="paper-count" style="display: inline;">&nbsp;</div>
      </p>

      <button id="take-paper-button">Take Paper</button>

      <div id="hand-content" style="display: none;">
        <p />
        <p id="paper-in-hand">No papers in hand</p>
        <button id="return-paper-button">Put All Cards Back</button>
        <button id="discard-paper-button">Discard Cards in Hand</button>
      </div>
    </div>

  </div>
  <p id="load">Firebase SDK Loading&hellip;</p>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥
      // // The Firebase SDK is initialized and available here!
      //
      // firebase.auth().onAuthStateChanged(user => { });
      // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
      // firebase.messaging().requestPermission().then(() => { });
      // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
      //
      // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥
      const db = firebase.firestore();
      var state = {
        roomId: null,
        papersInHand: []
      };

      // Button for inserting new papers.
      document.getElementById("word-input-button").addEventListener("click", function () {
        const newPaperText = document.getElementById("word-input-text").value.toUpperCase();
        putPapersInHat([newPaperText]);
      });
      // Enter button does the same thing as clicking the Insert button.
      document.getElementById("word-input-text").addEventListener("keyup", function (event) {
        event.preventDefault();
        if (event.keyCode === 13) {
          document.getElementById("word-input-button").click();
        }
      });

      // Put array of papers into the hat.
      // newPapers: array of strings.
      // Empty strings will be ignored and not inserted.
      function putPapersInHat(newPapers) {
        const filteredNewPapers = newPapers.filter(function (x) {
          return x;
        });
        const roomId = state.roomId;
        firebase.firestore().runTransaction(transaction => {
          const docRef = db.collection('rooms').doc(roomId);
          return transaction.get(docRef).then(snapshot => {
            const PAPERS_KEY = 'papers';
            var oldPapers = snapshot.get(PAPERS_KEY);
            if (!oldPapers) {
              oldPapers = [];
            }
            const updatedPapers = oldPapers.concat(filteredNewPapers);
            transaction.update(docRef, PAPERS_KEY, updatedPapers);
          });
        }).then(function () {
          console.log('Put', filteredNewPapers.length, 'paper(s) in hat');
          console.log('New papers in hat:', filteredNewPapers);
        }).catch(function (err) {
          console.error('Error inserting a paper', err);
        });
        // Clear text field after submission.
        document.getElementById("word-input-text").value = "";
      }

      // Button for taking a paper.
      document.getElementById("take-paper-button").addEventListener("click", function () {
        takePaper();
      });

      function takePaper() {
        const roomId = state.roomId;
        firebase.firestore().runTransaction(transaction => {
          const docRef = db.collection('rooms').doc(roomId);
          return transaction.get(docRef).then(snapshot => {
            const PAPERS_KEY = 'papers';
            var papers = snapshot.get(PAPERS_KEY);
            if (!papers || papers.length == 0) {
              return Promise.reject("No papers available!");
            }
            shuffle(papers);
            removedPaper = papers.pop();
            transaction.update(docRef, PAPERS_KEY, papers);
            return removedPaper;
          });
        }).then(function (removedPaper) {
          console.log('Took paper', removedPaper, 'from hat');
          putPaperInHand(removedPaper);
        }).catch(function (err) {
          console.error('Error taking a paper.', err);
        });
      }

      function putPaperInHand(paperForHand) {
        if (!paperForHand) {
          console.error('Cannot put paper in hand!', paperForHand);
          return;
        }
        state.papersInHand.push(paperForHand);
        console.log('Put paper', paperForHand, 'in hand');
        updateHandUI();
      }

      // Button for discarding papers.
      document.getElementById("discard-paper-button").addEventListener("click", function () {
        removeAllCardsInHand();
      });

      function removeAllCardsInHand() {
        const removedPapers = state.papersInHand;
        state.papersInHand = [];
        updateHandUI();
        console.log('Removed', removedPapers.length, 'paper(s) from hand');
        console.log('Removed papers:', removedPapers);
      }

      function updateHandUI() {
        const papersInHand = state.papersInHand;
        if (papersInHand && papersInHand.length) {
          document.getElementById("hand-content").style.display = 'block';
          document.getElementById("paper-in-hand").innerHTML = papersInHand.join('<br />');
        } else {
          document.getElementById("hand-content").style.display = 'none';
        }
      }

      function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      // Button  to return all cards.
      document.getElementById("return-paper-button").addEventListener("click", function () {
        putBackAllCardsInHand();
      });

      function putBackAllCardsInHand() {
        const papersInHand = state.papersInHand;
        if (!papersInHand) {
          console.error('No papers in hand!');
          return;
        }
        putPapersInHat(papersInHand);
        removeAllCardsInHand();
      }

      function displayRoom(roomId) {
        roomId = roomId.toUpperCase();
        state.roomId = roomId;
        document.getElementById('room-content').style.display = 'block';
        document.getElementById('room-id').innerHTML = roomId;
        createRoomIfRoomDoesNotExist(roomId);
        listenToPaperUpdates();
      }

      function createRoomIfRoomDoesNotExist(roomId) {
        // We need to be able to add items to the documente in a Firestore Transaction.
        // Transactions can only be run if the document already exists.
        // This ensures that any transactions are run on an existing document.
        // There is a race condition where multiple clients could try to
        // create the document at the same time, so initial data could be lost.
        // This race condition only happens on new rooms, so it seems better
        // than the other race condition that would happen on every update.
        const docRef = db.collection('rooms').doc(roomId);
        docRef.get()
          .then((docSnapshot) => {
            if (docSnapshot.exists) {
              // Do nothing if document already exists.
            } else {
              docRef.set({}) // Create empty document.
            }
          });
      }

      var roomUnsubscribe = undefined;
      function listenToPaperUpdates() {
        const roomId = state.roomId;
        if (roomUnsubscribe) {
          // Unsubscribe from previous room updates.
          roomUnsubscribe();
        }
        roomUnsubscribe = db.collection('rooms').doc(roomId).onSnapshot(function (doc) {
          var paperCount = 0;
          const data = doc.data();
          if (data) {
            const papers = data.papers;
            if (papers) {
              paperCount = papers.length;
            } else {
              console.log('No papers found in room', roomId);
            }
          } else {
            console.log('No data');
          }
          updatePaperCount(paperCount);
        });
      }

      function updatePaperCount(paperCount) {
        document.getElementById('count-in-hat').innerHTML = 'Paper count: <br />';
        document.getElementById('paper-count').innerHTML = paperCount;
      }

      function hideRoom() {
        document.getElementById('room-content').style.display = 'none';
      }

      function displayLobby() {
        document.getElementById('lobby-content').style.display = 'block';
        document.getElementById('room-id').innerHTML = "Join or create a room";
      }

      function hideLobby() {
        document.getElementById('lobby-content').style.display = 'none';
      }

      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const roomId = urlParams.get('r');
      if (roomId) {
        hideLobby();
        displayRoom(roomId);
      } else {
        hideRoom();
        displayLobby();
      }

      try {
        let app = firebase.app();
        let features = ['auth', 'database', 'firestore', 'messaging', 'storage'].filter(feature => typeof app[feature] === 'function');
        document.getElementById('load').innerHTML = `Firebase SDK loaded with ${features.join(', ')}`;
      } catch (e) {
        console.error(e);
        document.getElementById('load').innerHTML = 'Error loading the Firebase SDK, check the console.';
      }
    });
  </script>
</body>

</html>